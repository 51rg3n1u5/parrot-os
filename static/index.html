<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParrotOS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #1a1a2e; color: #eee; overflow: hidden; }
        #menu { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #16213e; display: flex; border-bottom: 3px solid #e94560; z-index: 100; }
        .menu-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; background: transparent; color: #aaa; font-size: 14px; cursor: pointer; }
        .menu-btn.active { color: #fff; background: rgba(233, 69, 96, 0.2); }
        #status { position: fixed; top: 60px; left: 0; right: 0; height: 35px; background: #0f3460; display: flex; align-items: center; justify-content: space-around; font-size: 13px; }
        .val { color: #4ecca3; font-weight: bold; }
        #content { position: fixed; top: 95px; left: 0; right: 0; bottom: 0; }
        .page { display: none; }
        .page.active { display: block; }
        #game { background: #0d1b2a; position: relative; overflow: hidden; }
        #game-score { position: absolute; top: 15px; left: 15px; font-size: 28px; color: #4ecca3; font-weight: bold; z-index: 50; }
        .tgt { position: absolute; width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; cursor: pointer; }
        .tgt:active { transform: scale(0.85); }
        .food { background: linear-gradient(#f39c12, #e74c3c); }
        .toy { background: linear-gradient(#9b59b6, #3498db); }
        .fruit { background: linear-gradient(#2ecc71, #27ae60); }
        #calm { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(#0d1b2a, #1b263b); }
        .brth { width: 150px; height: 150px; border-radius: 50%; background: radial-gradient(#415a77, #1b263b); animation: b 4s ease-in-out infinite; }
        @keyframes b { 0%,100% { transform: scale(1); } 50% { transform: scale(1.4); } }
        #admin { padding: 20px; }
        .sec { background: #16213e; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .btn { padding: 12px 24px; background: #4ecca3; color: #1a1a2e; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px; }
        #home { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(#1a1a2e, #16213e); }
    </style>
</head>
<body>
    <nav id="menu">
        <button class="menu-btn active" data-p="home">üè†<div>Hem</div></button>
        <button class="menu-btn" data-p="game">üéÆ<div>Lek</div></button>
        <button class="menu-btn" data-p="calm">üåô<div>Lugnt</div></button>
        <button class="menu-btn" data-p="admin">‚öôÔ∏è<div>Admin</div></button>
    </nav>
    <div id="status">
        <span>Mat: <span class="val" id="pellets">--</span></span>
        <span>Bonus: <span class="val" id="bonus">--</span></span>
        <span>Po√§ng: <span class="val" id="score">0</span></span>
    </div>
    <div id="content">
        <div id="home" class="page active"><h1>ü¶ú ParrotOS</h1><p style="color:#888;font-size:20px">Tryck p√• Lek</p></div>
        <div id="game" class="page"><div id="game-score">Po√§ng: <span id="pts">0</span></div></div>
        <div id="calm" class="page"><div class="brth"></div><p style="margin-top:30px;color:#778da9;font-size:24px">Shh... lugnt nu</p></div>
        <div id="admin" class="page">
            <h2 style="color:#4ecca3;margin-bottom:15px">Admin</h2>
            <div class="sec"><h3>Utfodring</h3><p style="margin:10px 0">Mat idag: <span id="admin-p" class="val">--</span></p><button class="btn" onclick="doFeed(10)">Ge 10g</button></div>
            <div class="sec"><h3>WLED</h3><button class="btn" onclick="doWled('rainbow')">Regnb√•ge</button><button class="btn" onclick="doWled('off')">Av</button></div>
        </div>
    </div>

    <script>
        console.log('ParrotOS starting...');
        
        let pts = 0;
        let gameActive = false;
        let targets = [];
        let moveInt = null;
        let fallInt = null;
        const gameEl = document.getElementById('game');
        
        // Menu clicks
        document.querySelectorAll('.menu-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Menu click:', this.dataset.p);
                
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(this.dataset.p).classList.add('active');
                
                if(this.dataset.p === 'game') {
                    startGame();
                } else {
                    stopGame();
                }
            });
        });
        
        function startGame() {
            console.log('Starting game');
            gameActive = true;
            pts = 0;
            document.getElementById('pts').textContent = '0';
            
            targets.forEach(t => t.remove());
            targets = [];
            
            // Spawn 4 targets
            for(let i=0; i<4; i++) spawnTarget();
            
            // Move loop
            if(moveInt) clearInterval(moveInt);
            moveInt = setInterval(moveTargets, 50);
            
            // Fall loop
            if(fallInt) clearInterval(fallInt);
            fallInt = setInterval(() => spawnTarget(true), 2500);
        }
        
        function stopGame() {
            console.log('Stopping game');
            gameActive = false;
            if(moveInt) { clearInterval(moveInt); moveInt = null; }
            if(fallInt) { clearInterval(fallInt); fallInt = null; }
            targets.forEach(t => t.remove());
            targets = [];
        }
        
        function spawnTarget(falling) {
            if(!gameActive) return;
            
            const types = [
                {c:'food',e:'üå∞'},{c:'toy',e:'üß∏'},{c:'fruit',e:'üçé'},
                {c:'food',e:'ü•ú'},{c:'fruit',e:'üçá'}
            ];
            const t = types[Math.floor(Math.random() * types.length)];
            
            const el = document.createElement('div');
            el.className = 'tgt ' + t.c;
            el.textContent = t.e;
            
            const maxX = gameEl.clientWidth - 100;
            const maxY = gameEl.clientHeight - 100;
            
            let x = Math.random() * maxX + 5;
            let y = falling ? -100 : Math.random() * maxY + 5;
            
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            el.onclick = function() {
                pts++;
                document.getElementById('pts').textContent = pts;
                el.remove();
                targets = targets.filter(t => t.el !== el);
                setTimeout(() => spawnTarget(false), 200);
            };
            
            gameEl.appendChild(el);
            
            targets.push({
                el: el,
                x: x, y: y,
                vx: (Math.random() - 0.5) * 10,
                vy: falling ? 2 : (Math.random() - 0.5) * 10,
                falling: falling,
                remove: function() { if(el.parentNode) el.remove(); }
            });
        }
        
        function moveTargets() {
            if(!gameActive) return;
            
            const maxX = gameEl.clientWidth - 100;
            const maxY = gameEl.clientHeight - 100;
            
            targets.forEach((t, i) => {
                t.x += t.vx;
                t.y += t.vy;
                
                if(t.falling) {
                    if(t.y > maxY + 100) {
                        t.remove();
                        targets.splice(i, 1);
                        spawnTarget(true);
                    }
                } else {
                    if(t.x <= 0 || t.x >= maxX) { t.vx *= -1; t.x = Math.max(0, Math.min(t.x, maxX)); }
                    if(t.y <= 0 || t.y >= maxY) { t.vy *= -1; t.y = Math.max(0, Math.min(t.y, maxY)); }
                }
                
                t.el.style.left = t.x + 'px';
                t.el.style.top = t.y + 'px';
            });
        }
        
        // API calls
        async function doFeed(g) {
            try {
                const r = await fetch('/api/feed?amount=' + g, {method: 'POST'});
                const d = await r.json();
                document.getElementById('admin-p').textContent = d.total_today + 'g';
            } catch(e) { console.error('Feed error:', e); }
        }
        
        async function doWled(v) {
            try {
                await fetch('/api/wled/' + v);
            } catch(e) { console.error('WLED error:', e); }
        }
        
        // Load state once at start (don't loop)
        async function loadState() {
            try {
                const s = await fetch('/api/state').then(r => r.json());
                document.getElementById('pellets').textContent = s.pellets_today + '/' + s.pellet_budget + 'g';
                document.getElementById('bonus').textContent = s.bonus_earned + 'g';
                document.getElementById('score').textContent = s.bonus_earned * 10;
                document.getElementById('admin-p').textContent = s.pellets_today + 'g';
            } catch(e) { console.error('State error:', e); }
        }
        
        loadState();
        console.log('ParrotOS ready');
    </script>
</body>
</html>
