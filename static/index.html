<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ParrotOS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #1a1a2e; color: #eee; touch-action: none; }
        
        .menu { display: flex; background: #16213e; padding: 10px; gap: 10px; }
        .menu button { flex: 1; padding: 15px; font-size: 18px; border: none; background: #0f3460; color: #aaa; cursor: pointer; border-radius: 8px; }
        .menu button.active { background: #e94560; color: #fff; }
        
        .bar-container { background: #0f3460; padding: 8px 15px; display: flex; align-items: center; gap: 15px; }
        .bar-label { color: #5dade2; font-weight: bold; }
        .bar-track { flex: 1; height: 24px; background: #1a1a2e; border-radius: 12px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #5dade2, #2ecc71); transition: width 0.3s; }
        
        .status { display: flex; background: #0f3460; padding: 8px; justify-content: space-around; font-size: 13px; }
        .status span { color: #4ecca3; font-weight: bold; }
        
        .page { display: none; min-height: calc(100vh - 130px); }
        .page.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #game { position: relative; background: #0d1b2a; }
        
        .target {
            position: absolute; width: 80px; height: 80px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; cursor: pointer;
        }
        .food { background: linear-gradient(#f39c12, #e74c3c); }
        .toy { background: linear-gradient(#9b59b6, #3498db); }
        .fruit { background: linear-gradient(#2ecc71, #27ae60); }
        
        .touch-dot {
            position: absolute;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(46, 204, 113, 0.6);
            border: 3px solid #2ecc71;
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: appear 0.2s ease-out, fadeout 1s 1s forwards;
        }
        @keyframes appear {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes fadeout {
            to { opacity: 0; }
        }
        
        .breath { width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(#415a77, #1b263b); animation: b 4s ease-in-out infinite; }
        @keyframes b { 0%,100% { transform: scale(1); } 50% { transform: scale(1.4); } }
        
        .sec { background: #16213e; padding: 20px; border-radius: 8px; margin: 10px; }
        .btn { padding: 15px 30px; background: #4ecca3; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px; }
        
        .touch-test { background: #16213e; padding: 15px; border-radius: 8px; margin: 10px; font-family: monospace; font-size: 12px; max-height: 150px; overflow-y: auto; }
        
        #ws-status { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #666; }
    </style>
</head>
<body>
    <div class="menu">
        <button id="b1" onclick="go('home', this)">Hem</button>
        <button id="b2" onclick="go('game', this)">Lek</button>
        <button id="b3" onclick="go('calm', this)">Lugnt</button>
        <button id="b4" onclick="go('admin', this)">Admin</button>
    </div>
    
    <div class="bar-container">
        <span class="bar-label">FÃ¥ngster:</span>
        <div class="bar-track"><div class="bar-fill" id="bar"></div></div>
    </div>
    
    <div class="status">
        <div>Mat: <span id="pellets">--</span></div>
        <div>Bonus: <span id="bonus">--</span></div>
        <div>Captures: <span id="captures">0</span>/10</div>
    </div>
    
    <div id="home" class="page active">
        <h1 style="font-size:48px">ðŸ¦œ ParrotOS</h1>
        <p style="color:#888">Tryck pÃ¥ Lek</p>
    </div>
    
    <div id="game" class="page"></div>
    
    <div id="calm" class="page">
        <div class="breath"></div>
        <p style="margin-top:20px;color:#778da9;font-size:20px">Shh...</p>
    </div>
    
    <div id="admin" class="page">
        <h2 style="color:#4ecca3">Admin</h2>
        <div class="sec">
            <h3>Utfodring</h3>
            <p>Mat idag: <span id="admin-p">--</span></p>
            <button class="btn" onclick="feed(10)">Ge 10g</button>
        </div>
        <div class="sec">
            <h3>WLED</h3>
            <button class="btn" onclick="wled('rainbow')">RegnbÃ¥ge</button>
            <button class="btn" onclick="wled('off')">Av</button>
        </div>
        <div class="sec">
            <h3>Touch Test</h3>
            <p>Status: <span id="touch-status" style="color:red">Inte ansluten</span></p>
            <p>Antal: <span id="touch-count">0</span></p>
            <div id="touch-log" class="touch-test"></div>
        </div>
    </div>
    
    <div id="ws-status">Touch: ðŸ”´</div>

    <script>
        let captures = 0;
        const maxCaptures = 10;
        let gameOn = false;
        let targets = [];
        let touches = {};
        let touchDots = {};
        let lastCheck = 0;
        const touchMaxX = 32600;
        const touchMaxY = 32600;
        const gameEl = document.getElementById('game');
        
        function logTouch(msg) {
            document.getElementById('touch-log').innerHTML = msg + '<br>' + document.getElementById('touch-log').innerHTML;
        }
        
        function updateBar() {
            const pct = (captures / maxCaptures) * 100;
            document.getElementById('bar').style.width = pct + '%';
            document.getElementById('captures').textContent = captures;
        }
        
        function go(page, btn) {
            document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            
            if (page === 'game' && !gameOn) startGame();
            else if (page !== 'game' && gameOn) stopGame();
        }
        
        function startGame() {
            gameOn = true;
            touches = {};
            Object.values(touchDots).forEach(d => d.remove());
            touchDots = {};
            
            if (captures >= maxCaptures) { captures = 0; updateBar(); }
            for (let i = 0; i < 3; i++) setTimeout(() => spawn(), i * 100);
            animate();
        }
        
        function stopGame() {
            gameOn = false;
            touches = {};
            Object.values(touchDots).forEach(d => d.remove());
            touchDots = {};
            targets.forEach(t => t.el.remove());
            targets = [];
        }
        
        function spawn() {
            if (!gameOn) return;
            const types = [{c:'food',e:'ðŸŒ°'},{c:'toy',e:'ðŸ§¸'},{c:'fruit',e:'ðŸŽ'}];
            const t = types[Math.floor(Math.random() * types.length)];
            
            const el = document.createElement('div');
            el.className = 'target ' + t.c;
            el.textContent = t.e;
            
            const w = gameEl.clientWidth || 300;
            const h = gameEl.clientHeight || 400;
            
            el.style.left = (Math.random() * (w - 90)) + 'px';
            el.style.top = (Math.random() * (h - 90)) + 'px';
            
            el.onpointerdown = function(e) { hitTarget(el); };
            
            gameEl.appendChild(el);
            
            targets.push({
                el: el,
                x: parseFloat(el.style.left),
                y: parseFloat(el.style.top),
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2
            });
        }
        
        function hitTarget(el) {
            el.remove();
            targets = targets.filter(x => x.el !== el);
            captures = Math.min(captures + 1, maxCaptures);
            updateBar();
            spawn();
        }
        
        function animate() {
            if (!gameOn) return;
            const w = gameEl.clientWidth || 300;
            const h = gameEl.clientHeight || 400;
            
            targets.forEach(t => {
                t.x += t.vx;
                t.y += t.vy;
                if (t.x <= 0 || t.x >= w - 90) { t.vx *= -1; t.x = Math.max(0, Math.min(t.x, w - 90)); }
                if (t.y <= 0 || t.y >= h - 90) { t.vy *= -1; t.y = Math.max(0, Math.min(t.y, h - 90)); }
                t.el.style.left = t.x + 'px';
                t.el.style.top = t.y + 'px';
            });
            requestAnimationFrame(animate);
        }
        
        function scaleTouch(rawX, rawY) {
            return {
                x: (rawX / touchMaxX) * window.innerWidth,
                y: (rawY / touchMaxY) * window.innerHeight
            };
        }
        
        function createTouchDot(slot, rawX, rawY) {
            const scaled = scaleTouch(rawX, rawY);
            
            const dot = document.createElement('div');
            dot.className = 'touch-dot';
            dot.style.left = scaled.x + 'px';
            dot.style.top = scaled.y + 'px';
            document.body.appendChild(dot);
            touchDots[slot] = dot;
            
            // Remove after 2 seconds
            setTimeout(() => {
                if (touchDots[slot]) {
                    touchDots[slot].remove();
                    delete touchDots[slot];
                }
            }, 2000);
        }
        
        function updateTouchDot(slot, rawX, rawY) {
            if (!touchDots[slot]) {
                createTouchDot(slot, rawX, rawY);
                return;
            }
            
            const scaled = scaleTouch(rawX, rawY);
            touchDots[slot].style.left = scaled.x + 'px';
            touchDots[slot].style.top = scaled.y + 'px';
        }
        
        function checkHits() {
            if (!gameOn || targets.length === 0) return;
            
            const rect = gameEl.getBoundingClientRect();
            
            Object.values(touches).forEach(touch => {
                const scaled = scaleTouch(touch.x, touch.y);
                const rx = scaled.x - rect.left;
                const ry = scaled.y - rect.top;
                
                for (let i = targets.length - 1; i >= 0; i--) {
                    const t = targets[i];
                    const dist = Math.sqrt((rx - t.x - 40) ** 2 + (ry - t.y - 40) ** 2);
                    if (dist < 60) {
                        hitTarget(t.el);
                        return;
                    }
                }
            });
        }
        
        let ws = null;
        
        function connectWS() {
            ws = new WebSocket('ws://localhost:8765');
            
            ws.onopen = function() {
                document.getElementById('ws-status').textContent = 'Touch: ðŸŸ¢';
                document.getElementById('touch-status').textContent = 'Ansluten!';
                document.getElementById('touch-status').style.color = '#2ecc71';
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'touch_start') {
                        const slot = data.slot !== undefined ? data.slot : 0;
                        touches[slot] = {x: data.x || 0, y: data.y || 0};
                        createTouchDot(slot, data.x || 0, data.y || 0);
                        document.getElementById('touch-count').textContent = Object.keys(touches).length;
                    }
                    else if (data.type === 'touch_move') {
                        const slot = data.slot !== undefined ? data.slot : 0;
                        touches[slot] = {x: data.x, y: data.y};
                        updateTouchDot(slot, data.x, data.y);
                        document.getElementById('touch-count').textContent = Object.keys(touches).length;
                        
                        if (Date.now() - lastCheck > 100) {
                            checkHits();
                            lastCheck = Date.now();
                        }
                    }
                    else if (data.type === 'touch_end') {
                        const keys = Object.keys(touches);
                        if (keys.length > 0) {
                            const removedSlot = keys[0];
                            if (touchDots[removedSlot]) {
                                touchDots[removedSlot].remove();
                                delete touchDots[removedSlot];
                            }
                            delete touches[removedSlot];
                        }
                        document.getElementById('touch-count').textContent = Object.keys(touches).length;
                    }
                } catch(e) {}
            };
            
            ws.onclose = function() {
                document.getElementById('ws-status').textContent = 'Touch: ðŸ”´';
                document.getElementById('touch-status').textContent = 'FrÃ¥nkopplad';
                setTimeout(connectWS, 2000);
            };
        }
        
        connectWS();
        
        async function feed(g) {
            try {
                const r = await fetch('/api/feed?amount=' + g, {method: 'POST'});
                const d = await r.json();
                document.getElementById('admin-p').textContent = d.total_today + 'g';
                loadState();
            } catch(e) {}
        }
        
        async function wled(v) { try { await fetch('/api/wled/' + v); } catch(e) {} }
        
        async function loadState() {
            try {
                const s = await fetch('/api/state').then(r => r.json());
                document.getElementById('pellets').textContent = s.pellets_today + '/' + s.pellet_budget + 'g';
                document.getElementById('bonus').textContent = s.bonus_earned + 'g';
                document.getElementById('admin-p').textContent = s.pellets_today + 'g';
            } catch(e) {}
        }
        
        loadState();
    </script>
</body>
</html>
